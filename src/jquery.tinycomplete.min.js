/*!
 * jquery.tinycomplete [ https://github.com/nestisamet/jquery.tinycomplete ]
 * requires jquery.scrollintoview [https://github.com/litera/jquery-scrollintoview]
 * 
 * Copyright 2014 stemizer.net ~ info<a>stemizer<d>net
 * Licensed under the MIT license
 * http://opensource.org/licenses/mit
 */
(function(a){a.fn.tinycomplete=function(e){function d(o){function b(){"list"!=c.type&&p.slideUp("fast")}var n=this,j,p,i,h=!1;o.addClass("tc-obj").attr("autocomplete","off").keydown(function(f){if(p){if((9===f.keyCode||13===f.keyCode)&&p.is(":visible")&&(a(".item-active:first",p).click().removeClass("item-active"),13==f.keyCode)){return !1}if(c.enterkey||13!==f.keyCode){if(38===f.keyCode){return p.show(),f=a(".item-active",p).index()-1,0>f&&(f=p.children().length-1),p.children().removeClass("item-active"),p.children().eq(f).addClass("item-active"),"list"==c.type&&p.children().eq(f).click(),p.children().eq(f).scrollintoview({duration:0}),!1}if(40===f.keyCode){return p.show(),f=a(".item-active",p).index()+1,f==p.children().length&&(f=0),p.children().removeClass("item-active"),p.children().eq(f).addClass("item-active"),"list"==c.type&&p.children().eq(f).click(),p.children().eq(f).scrollintoview({duration:0}),!1}27===f.keyCode&&b()}else{return p.slideDown(function(){n.deactivate();a(this).children().first().addClass("item-active").scrollintoview()}),!1}}else{if(13===f.keyCode){return !1}}}).keyup(function(f){j.css("min-width",a(this).outerWidth());if(!h&&27!=f.keyCode&&39!=f.keyCode&&37!=f.keyCode){38!=f.keyCode&&40!=f.keyCode&&a(".item-active").removeClass("item-active");if(o.val().length<c.minlen||38==f.keyCode||40==f.keyCode||13==f.keyCode&&!c.enterkey){return}if(!c.enterkey||c.enterkey&&13==f.keyCode){c.requestkey||(c.requestkey=o.attr("id")||"tinycomplete"),a.ajax({type:c.requestmethod,url:c.requesturl,data:c.requestkey+"="+o.val(),beforeSend:function(){a(".tc-spinner").removeClass("tc-spinner");o.addClass("tc-spinner");c.enterkey&&o.attr("readonly","readonly")},success:function(g){if("json"==c.responsetype){var k="";g.data&&(k='<ul class="tc-container">',a.each(g.data,function(l,m){k+=g.tpl.replace(/{([^{} ]+)}/g,function(r,q){return m[q]})}),k+="</ul>");g=k}if(a(":focus").is(o)||"list"==c.type){j.html(g),p=j.find(".tc-container"),p.children().addClass(c.itemclass).eq(0).addClass("item-active").scrollintoview(),p.css("overflow-y","combo"==c.type&&2>p.children().length?"hidden":"scroll"),"list"==c.type?p.children().click(function(l){a(l.target).closest("."+c.itemoperations).length||(n.deactivate(),a(this).addClass("item-active"),n.focus())}).eq(0).click():p.children().mouseover(function(){n.deactivate();a(this).addClass("item-active")}).click(function(l){a(l.target).closest("."+c.itemoperations).length||(o.val(a(this).data("val")||a.trim(a(this).text())),a(this).data("hiddenVal")&&(o.prev("."+c.hiddenobj).length||o.before('<input class="'+c.hiddenobj+'" type="hidden">'),o.prev("."+c.hiddenobj).val(a(this).data("hiddenVal"))),b(),h=!0)}),"function"===a.type(c.callback)&&c.callback.call(this,o,n)}o.removeClass("tc-spinner");c.enterkey&&o.removeAttr("readonly")}})}}h=!1}).click(function(){p&&"combo"==c.type&&(n.deactivate(),p.show().children().eq(0).addClass("item-active").scrollintoview())}).focus(function(){o.removeData("internalFocus")}).blur(function(){p&&("combo"!=c.type||o.data("internalFocus")||p.fadeOut("fast"),o.removeData("internalFocus"),"list"!=c.type||i&&i.closest("."+c.itemoperations).length||setTimeout(function(){o.focus()},0))});o.next(".tc-wrapper").length||o.after('<div class="tc-wrapper"></div>');j=o.next(".tc-wrapper");j.attr("unselectable","on").css("user-select","none").on("selectstart",!1).mousedown(function(f){i=a(f.target)}).mouseup(function(){o.removeData("internalFocus");i=null}).bind("mousewheel DOMMouseScroll",function(f){if("list"==c.type&&"DOMMouseScroll"==f.type||"mousewheel"==f.type){-3==f.originalEvent.detail||120==f.originalEvent.wheelDelta?o.trigger(a.Event("keydown",{keyCode:38})):3!=f.originalEvent.detail&&-120!=f.originalEvent.wheelDelta||o.trigger(a.Event("keydown",{keyCode:40})),f.preventDefault()}});"combo"==c.type?a(document).mousedown(function(f){if(a(f.target).closest(j).length){return o.data("internalFocus",!0),n.focus(0),!1}}):c.enterkey=!0;a(window).resize(function(){j.css("min-width",o.outerWidth())});n.run=function(){o.focus().trigger(a.Event("keyup",{keyCode:13}))};n.deactivate=function(){a(".item-active",p).removeClass("item-active")};n.activate=function(f){"list"==c.type&&(n.deactivate(),p.children().eq(f).addClass("item-active").click().scrollintoview())};n.focus=function(f){o.is(":focus")||(void 0===f?o.focus():setTimeout(function(){o.focus()},f))};c.minlen||n.run()}var c=a.extend({},{type:"combo",enterkey:!1,minlen:2,requestmethod:"post",requesturl:null,requestkey:null,responsetype:"json",itemclass:"tc-item",hiddenobj:"tc-hidden",itemoperations:"tc-item-operations",callback:null},e);this.each(function(){a.data(this,"tinycomplete")||a.data(this,"tinycomplete",new d(a(this)))});return this.data("tinycomplete")}})(jQuery);